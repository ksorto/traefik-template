# Traefik TLS Configuration Guide

This guide provides step-by-step instructions for configuring TLS/HTTPS with Traefik using `mkcert` for local development.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Traefik Configuration](#traefik-configuration)
- [Certificate Generation](#certificate-generation)
- [Application Configuration](#application-configuration)
- [Testing](#testing)
- [Troubleshooting](#troubleshooting)

## Prerequisites

- Docker and Docker Compose installed
- Terminal/Shell access
- Administrator/Sudo privileges for certificate installation

## Installation

### 1. Install mkcert

#### Windows

```powershell
# Download mkcert for Windows
# Visit: https://github.com/FiloSottile/mkcert/releases
# Download the latest Windows release

# Or use Chocolatey (if installed)
choco install mkcert

# Or use Scoop (if installed)
scoop install mkcert
```

#### macOS

```bash
# Using Homebrew (recommended)
brew install mkcert

# Or download from GitHub releases
# Visit: https://github.com/FiloSottile/mkcert/releases
```

#### Linux (Ubuntu/Debian)

```bash
# Install using apt
sudo apt install libnss3-tools
wget -O mkcert https://github.com/FiloSottile/mkcert/releases/download/v1.4.4/mkcert-v1.4.4-linux-amd64
chmod +x mkcert
sudo mv mkcert /usr/local/bin/

# Or using snap
sudo snap install mkcert
```

#### Linux (CentOS/RHEL/Fedora)

```bash
# Install dependencies
sudo yum install nss-tools  # CentOS/RHEL
# or
sudo dnf install nss-tools  # Fedora

# Download and install mkcert
wget -O mkcert https://github.com/FiloSottile/mkcert/releases/download/v1.4.4/mkcert-v1.4.4-linux-amd64
chmod +x mkcert
sudo mv mkcert /usr/local/bin/
```

### 2. Install the Local CA

Run the following command to install the local Certificate Authority:

#### Windows
```powershell
# Run as Administrator
mkcert -install
```

#### macOS/Linux
```bash
# Run with sudo
sudo mkcert -install
```

This will install the local CA in your system's trust store, allowing browsers to trust certificates generated by mkcert.

## Traefik Configuration

### 1. Docker Compose Setup

Your `docker-compose.yml` should include the following Traefik configuration:

```yaml
networks:
  traefik:
    external: true

services:
  traefik:
    image: traefik:v2.10
    container_name: traefik
    restart: unless-stopped
    command:
      # Dashboard (unsafe for prod; local only)
      - --api.insecure=true

      # Providers
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.file.filename=/dynamic/tls.yml
      - --providers.file.watch=true

      # Entrypoints
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443

      # Logging
      - --log.level=DEBUG

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./certs:/certs:ro
      - ./dynamic:/dynamic:ro

    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"

      # Dashboard route (HTTPS)
      - "traefik.http.routers.traefik.rule=Host(`admin.traefik.local`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.routers.traefik.service=api@internal"

      # API route (HTTPS)
      - "traefik.http.routers.traefik-api.rule=Host(`admin.traefik.local`) && PathPrefix(`/api`)"
      - "traefik.http.routers.traefik-api.entrypoints=websecure"
      - "traefik.http.routers.traefik-api.tls=true"
      - "traefik.http.routers.traefik-api.service=api@internal"

      # HTTP to HTTPS redirect
      - "traefik.http.routers.traefik-redirect.rule=Host(`admin.traefik.local`)"
      - "traefik.http.routers.traefik-redirect.entrypoints=web"
      - "traefik.http.routers.traefik-redirect.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

    networks:
      - traefik
```

### 2. TLS Configuration File

Create or update `dynamic/tls.yml`:

```yaml
# dynamic/tls.yml
tls:
  stores:
    default:
      defaultCertificate:
        certFile: /certs/_wildcard.adhere.local.pem
        keyFile: /certs/_wildcard.adhere.local-key.pem

  certificates:
    - certFile: /certs/_wildcard.adhere.local.pem
      keyFile: /certs/_wildcard.adhere.local-key.pem
    - certFile: /certs/admin.traefik.local.pem
      keyFile: /certs/admin.traefik.local-key.pem
```

## Certificate Generation

### 1. Generate Certificates

Generate certificates for your domains:

#### Windows (PowerShell)
```powershell
# Generate certificate for Traefik dashboard
mkcert admin.traefik.local

# Generate wildcard certificate for your domain
mkcert "*.example.local" "example.local"

# Move certificates to the certs directory
Move-Item "admin.traefik.local.pem" "certs/" -Force
Move-Item "admin.traefik.local-key.pem" "certs/" -Force
Move-Item "_wildcard.example.local.pem" "certs/" -Force
Move-Item "_wildcard.example.local-key.pem" "certs/" -Force
```

#### macOS/Linux (Bash)
```bash
# Generate certificate for Traefik dashboard
mkcert admin.traefik.local

# Generate wildcard certificate for your domain
mkcert "*.example.local" "example.local"

# Move certificates to the certs directory
mv admin.traefik.local.pem certs/
mv admin.traefik.local-key.pem certs/
mv _wildcard.example.local.pem certs/
mv _wildcard.example.local-key.pem certs/
```

### 2. Update Hosts File

Add your domains to the hosts file:

#### Windows
Edit `C:\Windows\System32\drivers\etc\hosts` (run as Administrator):
```
127.0.0.1 admin.traefik.local
127.0.0.1 app.example.local
127.0.0.1 example.local
```

#### macOS/Linux
Edit `/etc/hosts` (run with sudo):
```bash
sudo nano /etc/hosts
# or
sudo vim /etc/hosts
```

Add the following lines:
```
127.0.0.1 admin.traefik.local
127.0.0.1 app.example.local
127.0.0.1 example.local
```

## Application Configuration

### Example: Directus Configuration

Here's how to configure a Directus application with TLS:

```yaml
services:
  directus:
    image: directus/directus:latest
    container_name: directus
    restart: unless-stopped
    environment:
      - KEY=your-secret-key
      - SECRET=your-secret-secret
      - DB_CLIENT=mysql
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_DATABASE=directus
      - DB_USER=directus
      - DB_PASSWORD=directus
    volumes:
      - directus_uploads:/directus/uploads
      - directus_extensions:/directus/extensions
    networks:
      - traefik
      - internal
    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"

      # HTTP router: redirect to HTTPS
      - "traefik.http.routers.directus.rule=Host(`app.example.local`)"
      - "traefik.http.routers.directus.entrypoints=web"
      - "traefik.http.routers.directus.middlewares=directus-https-redirect"

      # HTTPS router
      - "traefik.http.routers.directus-secure.rule=Host(`app.example.local`)"
      - "traefik.http.routers.directus-secure.entrypoints=websecure"
      - "traefik.http.routers.directus-secure.tls=true"

      # Service upstream port (Directus default)
      - "traefik.http.services.directus.loadbalancer.server.port=8055"

      # Middleware: HTTP -> HTTPS
      - "traefik.http.middlewares.directus-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.directus-https-redirect.redirectscheme.permanent=true"

networks:
  traefik:
    external: true
  internal:
    driver: bridge

volumes:
  directus_uploads:
  directus_extensions:
```

### Generic Application Template

For any application, use this template:

```yaml
services:
  your-app:
    image: your-app:latest
    container_name: your-app
    restart: unless-stopped
    # Your application environment variables
    environment:
      - APP_ENV=production
    # Your application volumes
    volumes:
      - app_data:/app/data
    networks:
      - traefik
      - internal
    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"

      # HTTP router: redirect to HTTPS
      - "traefik.http.routers.your-app.rule=Host(`your-app.example.local`)"
      - "traefik.http.routers.your-app.entrypoints=web"
      - "traefik.http.routers.your-app.middlewares=your-app-https-redirect"

      # HTTPS router
      - "traefik.http.routers.your-app-secure.rule=Host(`your-app.example.local`)"
      - "traefik.http.routers.your-app-secure.entrypoints=websecure"
      - "traefik.http.routers.your-app-secure.tls=true"

      # Service upstream port (replace 8080 with your app's port)
      - "traefik.http.services.your-app.loadbalancer.server.port=8080"

      # Middleware: HTTP -> HTTPS
      - "traefik.http.middlewares.your-app-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.your-app-https-redirect.redirectscheme.permanent=true"

networks:
  traefik:
    external: true
  internal:
    driver: bridge

volumes:
  app_data:
```

## Testing

### 1. Start Services

#### Windows (PowerShell)
```powershell
# Start Traefik
docker-compose up -d

# Start your application
docker-compose -f your-app-compose.yml up -d
```

#### macOS/Linux (Bash)
```bash
# Start Traefik
docker-compose up -d

# Start your application
docker-compose -f your-app-compose.yml up -d
```

### 2. Verify HTTPS Access

- **Traefik Dashboard**: `https://admin.traefik.local`
- **Your Application**: `https://your-app.adhere.local`

### 3. Check Certificate Validity

Open your browser's developer tools and verify:
- Certificate is valid and trusted
- No security warnings
- HTTPS redirect is working

## Troubleshooting

### Common Issues

#### 1. Certificate Not Trusted

#### Windows
```powershell
# Reinstall the local CA
mkcert -install
```

#### macOS/Linux
```bash
# Reinstall the local CA
sudo mkcert -install
```

#### 2. Domain Not Resolving
- Check your hosts file entries
- **Windows**: Ensure domains are correctly added to `C:\Windows\System32\drivers\etc\hosts`
- **macOS/Linux**: Ensure domains are correctly added to `/etc/hosts`

#### 3. Traefik Not Routing
- Verify the `traefik` network exists: `docker network ls`
- Check container logs: `docker logs traefik`
- Ensure labels are correctly formatted

#### 4. Port Conflicts

#### Windows
```powershell
# Check if ports 80/443 are available
netstat -ano | findstr :80
netstat -ano | findstr :443
```

#### macOS/Linux
```bash
# Check if ports 80/443 are available
netstat -tulpn | grep :80
netstat -tulpn | grep :443
# or
lsof -i :80
lsof -i :443
```

### Useful Commands

#### Windows (PowerShell)
```powershell
# Check Traefik logs
docker logs traefik

# List all networks
docker network ls

# Check running containers
docker ps

# Restart Traefik
docker-compose restart traefik

# Check certificate files
Get-ChildItem certs/
```

#### macOS/Linux (Bash)
```bash
# Check Traefik logs
docker logs traefik

# List all networks
docker network ls

# Check running containers
docker ps

# Restart Traefik
docker-compose restart traefik

# Check certificate files
ls -la certs/
```

## Security Notes

- This configuration is for **local development only**
- For production, use proper SSL certificates from a trusted CA
- Consider using Let's Encrypt for production environments
- Never commit private keys to version control

### Git Security

A `.gitignore` file is included to protect sensitive files:

```bash
# The following files/directories are automatically ignored:
certs/*.pem          # SSL certificates and private keys
letsencrypt/acme.json # Let's Encrypt certificates
dynamic/*.yml         # Dynamic configuration files
.env*                 # Environment files
```

**Important**: Always review the `.gitignore` file before committing to ensure no sensitive data is accidentally pushed to your repository.

## Additional Resources

- [Traefik Documentation](https://doc.traefik.io/traefik/)
- [mkcert GitHub Repository](https://github.com/FiloSottile/mkcert)
- [Docker Compose Documentation](https://docs.docker.com/compose/)
